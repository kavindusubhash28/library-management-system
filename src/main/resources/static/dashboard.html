<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Library Books</h2>
            <!-- Logout button -->
            <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
        <!-- Message area for feedback -->
        <div id="dashboardMessage"></div>
        <!-- Books table -->
        <table class="table table-striped" id="booksTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Book rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>
    <script>
        // Logout functionality: clears JWT and redirects to login
        document.getElementById('logoutBtn').onclick = function() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        };

        // Fetch and display all books and the current user's borrow history
        async function fetchBooksAndHistory() {
            const token = localStorage.getItem('jwtToken');
            // Fetch all books from backend
            const booksResponse = await fetch('/api/books');
            const books = await booksResponse.json();
            // Fetch current user's borrow history
            const historyResponse = await fetch('/api/borrow/history', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            const history = await historyResponse.json();
            // Get IDs of books currently borrowed by the user (not yet returned)
            const borrowedBookIds = history.filter(r => r.returnDate === null).map(r => r.book.id);
            // Populate the table
            const tbody = document.querySelector('#booksTable tbody');
            tbody.innerHTML = '';
            books.forEach(book => {
                // Check if this book is borrowed by the current user
                const isBorrowedByUser = borrowedBookIds.includes(book.id);
                // Set status and action button
                let status = 'Available';
                let actionBtn = `<button class=\"btn btn-primary btn-sm\" onclick=\"borrowBook(${book.id})\">Borrow</button>`;
                if (isBorrowedByUser) {
                    status = 'Borrowed';
                    actionBtn = `<button class=\"btn btn-warning btn-sm\" onclick=\"returnBook(${book.id})\">Return</button>`;
                }
                // Insert row into table
                tbody.innerHTML += `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${status}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });
        }

        // Borrow book: calls backend to borrow and refreshes table
        async function borrowBook(bookId) {
            const token = localStorage.getItem('jwtToken');
            const messageDiv = document.getElementById('dashboardMessage');
            messageDiv.innerHTML = '';
            try {
                const response = await fetch(`/api/borrow/${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const text = await response.text();
                if (response.ok) {
                    messageDiv.innerHTML = `<div class='alert alert-success'>${text}</div>`;
                    fetchBooksAndHistory();
                } else {
                    messageDiv.innerHTML = `<div class='alert alert-danger'>${text}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class='alert alert-danger'>Failed to borrow book.</div>`;
            }
        }

        // Return book: calls backend to return and refreshes table
        async function returnBook(bookId) {
            const token = localStorage.getItem('jwtToken');
            const messageDiv = document.getElementById('dashboardMessage');
            messageDiv.innerHTML = '';
            try {
                const response = await fetch(`/api/return/${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const text = await response.text();
                if (response.ok) {
                    messageDiv.innerHTML = `<div class='alert alert-success'>${text}</div>`;
                    fetchBooksAndHistory();
                } else {
                    messageDiv.innerHTML = `<div class='alert alert-danger'>${text}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class='alert alert-danger'>Failed to return book.</div>`;
            }
        }

        // Expose functions to global scope for button onclick
        window.borrowBook = borrowBook;
        window.returnBook = returnBook;

        // On page load: check for JWT and fetch books/history
        if (!localStorage.getItem('jwtToken')) {
            window.location.href = 'login.html';
        } else {
            fetchBooksAndHistory();
        }
    </script>
</body>
</html> 